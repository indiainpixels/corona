<!DOCTYPE html>
<html>

<head>
    <style>
        body {
            font-family: "Helvetica Neue", sans-serif;
            margin: 0;
            background: #0B154E;
        }

        .flagbox:nth-child(3){
            margin-bottom: 10px;
        }
        
        #yrwrapper {
            height: 100vh;
            width: 300px;
            background: #0D0B33;
            position: absolute;
            top: 0px;
            right: 0px;
            color: white;
            padding: 20px;
        }
        
        #yrcounter {
            font-weight: 800;
            font-size: 5em;
            color: white;
            text-align: center;
            margin-bottom: 25px;
            position: absolute;
            right: 400px;
            top: 100px;
        }
        
        .flagbox {
            display: flex;
            align-items: center;
            margin-left: 50px;
            margin-bottom: -25px;
        }
        
        #top5 {
            margin-top: 50px;
        }
        
        .flag {
            font-size: 5em;
            margin-right: 25px;
            margin-top: 20px;
        }
        
        .vaal {
            font-weight: 600;
            font-size: 2em;
        }
    </style>
</head>

<body>
    <div id="yrcounter"></div>
    <div id="yrwrapper">
        <div id="top5"></div>
    </div>
    <div id="map"></div>
    <script src="d3.js"></script>
    <script src="conf.js"></script>
    <script src="d3geo.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="topojson.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script>
        let yrnow = 0;
        let inc = 0.01;
        let currFacet = null;
        let valid_countries = facet["0"];

        function map(n, start1, stop1, start2, stop2) {
            return ((n - start1) / (stop1 - start1)) * (stop2 - start2) + start2;
        };

        function updateFacet() {
            const prevyr = parseInt(yrnow);
            const nxtyr = prevyr + 1;
            if (yrnow > 91) yrnow = 91;
            $("#yrcounter").html(moment("2020-01-22").add(yrnow, "days").format("DD MMM"))
            $("#specific").html(moment("2020-01-22").add(yrnow, "days").format("hh:mm a"))
            var color = d3
                .scaleLinear()
                .domain([0, 5, 1000, 10000])
                .range(["#09113a", "#ff0", "#f92774", "#b21a03"]);
            //TOP 5
            const menow = {};
            for (let cname in valid_countries) {
                const valz = map(yrnow, prevyr, nxtyr, facet[prevyr][cname], facet[nxtyr][cname]);
                menow[cname] = valz;
            }

            //const top5 = Object.entries(menow).sort((b, a) => a[1] - b[1]).slice(0, 7);
            let top5 = [];
            top5.push(["India", menow["India"]])
            top5.push(["China", menow["China"]])
            top5.push(["USA", menow["USA"]])
            // top5.push(["Italy", menow["Italy"]])
            // top5.push(["Spain", menow["Spain"]])
            // top5.push(["South Korea", menow["South Korea"]])
            const newEntrants = Object.entries(menow).sort((b, a) => a[1] - b[1]).filter(v=>"IndiaChinaUSADiamond Princess".indexOf(v[0])==-1).slice(0,5);
            top5 = [...top5, ...newEntrants];
            $("#top5").html("");
            for (let elem of top5) {
                const kimo = kimoji.find(v => v.name === elem[0]);
                $("#top5").append(`<div class="flagbox">
              <div class="flag">${kimo && kimo.emoji}</div>
              <div class="naambox">
              <div class="naam">${elem[0]}</div>
              <div class="vaal">${parseInt(elem[1])}</div>
              </div>
              </div>`)
            }
            d3.json("world.json", function(error, data) {
                var svg = g
                    .selectAll(".subunit")
                    .data(topojson.feature(data, data.objects.polygons).features)
                    // .transition()
                    // .duration(700)
                    .style("fill", function(d, i) {
                        const cname = d.properties.name;
                        if (cname in menow) {
                            return color(menow[cname]);
                        } else {
                            return "#09113a";
                        }
                    });
            });
        }


        var width = window.innerWidth,
            height = window.innerHeight;

        var projection = d3.geoRobinson();

        var path = d3
            .geoPath()
            .projection(projection)
            .pointRadius(2);

        var svg = d3
            .select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        var g = svg.append("g");

        d3.json("world.json", function(error, data) {
            centerZoom(data);
            var subunits = drawSubUnits(data);
            // colorSubunits(subunits);
            // drawSubUnitLabels(data);
            // drawPlaces(data);
            // drawOuterBoundary(data, boundary);
        });

        function centerZoom(data) {
            var o = topojson.mesh(data, data.objects.polygons, function(a, b) {
                return a === b;
            });

            projection.scale(1).translate([0, 0]);

            var b = path.bounds(o),
                s =
                1 /
                Math.max((b[1][0] - b[0][0]) / width * 1.2, (b[1][1] - b[0][1]) / height * 1),
                t = [
                    (width - s * (b[1][0] + b[0][0])) * 0.35,
                    (height - s * (b[1][1] + b[0][1])) * 0.6
                ];

            var p = projection.scale(s).translate(t);

            return o;
        }

        function drawOuterBoundary(data, boundary) {
            g.append("path")
                .datum(boundary)
                .attr("d", path)
                .attr("class", "subunit-boundary")
                .attr("fill", "none")
                .attr("stroke", "#3a403d");
        }

        function drawPlaces(data) {
            g.append("path")
                .datum(topojson.feature(data, data.objects.places))
                .attr("d", path)
                .attr("class", "place");

            g.selectAll(".place-label")
                .data(topojson.feature(data, data.objects.places).features)
                .enter()
                .append("text")
                .attr("class", "place-label")
                .attr("transform", function(d) {
                    return "translate(" + projection(d.geometry.coordinates) + ")";
                })
                .attr("dy", ".35em")
                .attr("x", 6)
                .attr("text-anchor", "start")
                .style("font-size", ".7em")
                .style("text-shadow", "0px 0px 2px #fff")
                .text(function(d) {
                    return d.properties.name;
                });
        }

        function drawSubUnits(data) {
            var subunits = g
                .selectAll(".subunit")
                .data(topojson.feature(data, data.objects.polygons).features)
                .enter()
                .append("path")
                .attr("class", "subunit")
                .attr("d", path)
                .style("stroke", "#666")
                .style("stroke-width", "1px");

            return subunits;
        }

        function drawSubUnitLabels(data) {
            g.selectAll(".subunit-label")
                .data(topojson.feature(data, data.objects.polygons).features)
                .enter()
                .append("text")
                .attr("class", "subunit-label")
                .attr("transform", function(d) {
                    return "translate(" + path.centroid(d) + ")";
                })
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .style("font-size", ".5em")
                .style("text-shadow", "0px 0px 2px #fff")
                .style("text-transform", "uppercase")
                .text(function(d) {
                    return d.properties.name;
                });
        }

        function colorSubunits(subunits) {
            var c = d3.scaleOrdinal(d3.schemeCategory20);
            subunits
                .style("fill", function(d, i) {
                    return c(i);
                })
                .style("opacity", ".6");
        }
        setInterval(() => {
            yrnow += inc;
            updateFacet();
        }, 50)
    </script>
</body>

</html>